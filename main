from pybricks.pupdevices import Motor
from pybricks.parameters import Port, Direction, Button, Stop
from pybricks.robotics import DriveBase
from pybricks.hubs import PrimeHub
from pybricks.tools import wait


#=======================CONFIGURAÃ‡Ã•ES INICIAIS==========================#
hub = PrimeHub()

'''
print(hub.system.info()["name"])
# ðŸ”Ž Checagem de seguranÃ§a: sÃ³ roda se for o HUB certo
if hub.system.info()["name"] != "V8 HUB":
    print("Hub Errado")
    while True:               # trava execuÃ§Ã£o
        raise SystemExit  # encerra o programa
'''

hub.system.set_stop_button((Button.BLUETOOTH))

left_motor = Motor(Port.B, Direction.COUNTERCLOCKWISE)
right_motor = Motor(Port.F)
motor_direito = Motor(Port.A, Direction.COUNTERCLOCKWISE)
motor_esquerdo = Motor(Port.E)

# Initialize the drive base
drive_base = DriveBase(left_motor, right_motor, wheel_diameter=56, axle_track=112)
drive_base.use_gyro(True)


#=======================FUNÃ‡Ã•ES DE MOVIMENTO==========================#
def giroPID(angulo, kp, ki, kd):
    integral = 0
    ultimo_erro = 0
    while abs(hub.imu.heading()) < abs(angulo):
        erro = angulo - hub.imu.heading()
        integral = integral + erro
        derivativa = erro - ultimo_erro
        movimento = (erro * kp) + (integral * ki) + (derivativa * kd)
        left_motor.run(movimento)
        right_motor.run(-movimento)
        ultimo_erro = erro
    hub.imu.reset_heading(0)
    left_motor.stop()
    right_motor.stop()


def config(velocidade, aceleracao):
    drive_base.settings(velocidade, aceleracao)


def resetar_guinada():
    drive_base.use_gyro(False)
    hub.imu.reset_heading(0)
    drive_base.use_gyro(True)


#=======================MÃQUINA DE ESTADO==========================#
class StateMachine:
    def __init__(self, states):
        self.states = states
        self.index = 0

    def next_state(self):
        self.index = (self.index + 1) % len(self.states)
        self.show_state()

    def prev_state(self):
        self.index = (self.index - 1) % len(self.states)
        self.show_state()

    def run_state(self):
        state = self.states[self.index]
        print(f"Executando aÃ§Ã£o do estado: {state['name']}")
        state["action"]()

    def show_state(self):
        print(f"Estado atual: {self.states[self.index]['name']}")
        hub.display.number(self.index + 1)


#=======================FUNÃ‡Ã•ES DE STARTS==========================#
def start1():  # START DA COMPARTILHADA
    drive_base.use_gyro(True)

    drive_base.settings(500, 900)
    drive_base.straight(585)
    resetar_guinada()
    giroPID(-86, 2, 0.0005, 1)
    drive_base.straight(-310)
    resetar_guinada()
    giroPID(92, 2, 0.0005, 1)

    wait(200)
    drive_base.settings(300, 300)
    drive_base.straight(10)

    motor_direito.run_angle(300, -300, Stop.BRAKE, True)
    drive_base.settings(200, 1000)
    drive_base.straight(150)
    resetar_guinada()

    motor_esquerdo.run_time(-900, 3400, Stop.BRAKE, True)
    motor_esquerdo.run_time(400, 1500, Stop.BRAKE, True)
    resetar_guinada()
    drive_base.settings(900, 8000)
    drive_base.straight(-90)
    resetar_guinada()
    giroPID(82, 2, 0.005, 1)
    drive_base.settings(900, 8000)
    drive_base.straight(-250)
    resetar_guinada()
    giroPID(90, 5, 0.0005, 1)
    drive_base.settings(900, 9000)
    drive_base.straight(650)

    sm.next_state()
    drive_base.use_gyro(False)


def start2():  # START DO TRIDENTE
    drive_base.use_gyro(True)
    drive_base.settings(500, 2000)
    drive_base.straight(530)
    drive_base.settings(900, 8000)
    drive_base.straight(-150)
    drive_base.settings(350, 350)
    drive_base.straight(235)
    resetar_guinada()
    giroPID(-36, 1.5, 0.001, 1)
    drive_base.settings(400, 400)
    drive_base.straight(180)
    motor_esquerdo.run_angle(800, -300, Stop.BRAKE, True)


    drive_base.settings(600, 1000)
    drive_base.straight(-195)
    resetar_guinada()
    giroPID(-55, 2, 0.001, 1)
    motor_esquerdo.run_angle(800, 320, Stop.BRAKE, True)

    drive_base.settings(300, 300)
    drive_base.straight(100)
    motor_esquerdo.run_angle(800, -300, Stop.BRAKE, True)
    drive_base.straight(-20)
    motor_direito.run_angle(800, -500, Stop.BRAKE, True)
    giroPID(78, 2, 0.001, 1)
    drive_base.settings(900, 9000)
    drive_base.straight(-540)
    sm.next_state()
    drive_base.use_gyro(False)


def start3():  # START DA AREIA
    drive_base.use_gyro(True)
    drive_base.settings(400,400)
    drive_base.straight(570)
    drive_base.settings(900, 300)
    drive_base.straight(-500)

    sm.next_state()
    drive_base.use_gyro(False)


def start4():  # START DO GUINDASTE/3 ARTEFATOS
    drive_base.use_gyro(True)
    hub.imu.reset_heading(0)
    drive_base.settings(500, 900)
    drive_base.straight(180)
    resetar_guinada()
    giroPID(-48, 1.5, 0.001, 1)
    drive_base.straight(230)
    drive_base.settings(400, 900)
    drive_base.straight(-210)
    resetar_guinada()
    giroPID(47, 1.5, 0.001, 1)
    drive_base.straight(380)
    giroPID(-23, 1.5, 0.001, 1)

    motor_esquerdo.run_time(600, 700)
    drive_base.straight(120)
    resetar_guinada()
    giroPID(-64, 1.5, 0.0001, 1)
    drive_base.straight(90)
    drive_base.straight(-30)
    motor_esquerdo.run_time(-200, 1000)
    drive_base.straight(-40)
    resetar_guinada()
    giroPID(87, 2, 0.001, 1)
    drive_base.settings(500, 900)
    drive_base.straight(205)
    drive_base.settings(400, 500)
    resetar_guinada()
    giroPID(81, 2, 0.001, 1)
    drive_base.straight(165)
    drive_base.straight(-20)
    resetar_guinada()
    giroPID(-7, 2, 0.001, 1)
    motor_direito.run_angle(900, -900)
    drive_base.settings(700, 2000)
    drive_base.straight(-100)


    sm.next_state()
    drive_base.use_gyro(False)


def start5():  # START DO BALDE
    drive_base.use_gyro(True)

    drive_base.settings(300,300)
    drive_base.straight(240)
    giroPID(53,1.5,0.001,1)
    motor_direito.run_time(300, 800, Stop.BRAKE, True)
    wait(300)
    resetar_guinada()
    giroPID(-22,3,0.001,1)
    wait (100)
    resetar_guinada()
    giroPID(20,1.5,0.001,1)
    motor_direito.run_angle(-300, 200, Stop.BRAKE, True)
    drive_base.straight(210)
    wait(100)
    motor_direito.run_angle(300, 200, Stop.BRAKE, True)
    wait(100)
    drive_base.straight(-180)
    drive_base.straight(80)
    motor_direito.run_angle(-600, 250, Stop.BRAKE, True)
    drive_base.straight(-480)
    
    sm.next_state()
    drive_base.use_gyro(False)

def start6():  # START DAS PEDRAS
    drive_base.use_gyro(True)
    drive_base.settings(500, 600)
    drive_base.straight(565)
    resetar_guinada()
    giroPID(34, 1.2, 0.0002, 5)
    drive_base.settings(400, 400)
    drive_base.straight(100)
    resetar_guinada()
    drive_base.straight(-25)
    resetar_guinada()
    giroPID(54, 1.5, 0.0003, 1)
    drive_base.straight(100)
    motor_esquerdo.run_time(-700, 1200)
    drive_base.straight(135)
    motor_esquerdo.run_angle(600, 400, Stop.BRAKE, True)
    drive_base.straight(-200)
    resetar_guinada()
    giroPID(38, 1.5, 0.0003, 1)
    drive_base.settings(200, 200)
    drive_base.straight(-130)
    resetar_guinada()
    drive_base.settings(900, 9000)
    giroPID(-9, 3, 0.001, 1)
    drive_base.straight(30)
    resetar_guinada()
    giroPID(45, 2, 0.001, 1)
    drive_base.straight(660)

    sm.next_state()
    drive_base.use_gyro(False)


def start7():  # START DO SILO/INDIANA JONES
    drive_base.use_gyro(True)
    hub.imu.reset_heading(0)
    
    drive_base.settings(600, 1000)
    drive_base.straight(330)
    motor_direito.run_time(800, 1000, Stop.BRAKE, True)
    motor_direito.run_time(-800, 1000, Stop.BRAKE, True)
    motor_direito.run_time(800, 1000, Stop.BRAKE, True)
    motor_direito.run_time(-800, 1000, Stop.BRAKE, True)
    drive_base.settings(400, 400)
    resetar_guinada()
    giroPID(-20, 1.2, 0.0004, 1)
    drive_base.settings(300, 300)
    drive_base.straight(150)
    giroPID(-17, 1.2, 0.0004, 1)
    drive_base.straight(370)
    motor_esquerdo.run_time(-800, 1000, Stop.BRAKE, True)
    drive_base.straight(50)
    resetar_guinada()
    drive_base.straight(-50)
    giroPID(-7, 1.2, 0.0004, 1)
    wait (100)
    drive_base.settings(900, 8000)
    drive_base.straight(-280)
    resetar_guinada()
    giroPID(25, 1.2, 0.0004, 1)
    drive_base.straight(-520)
    
    sm.next_state()
    drive_base.use_gyro(False)

def start8():  # START DOS ARTEFATOS
    drive_base.use_gyro(True)
    hub.imu.reset_heading(0)
    drive_base.settings(500, 700)
    drive_base.straight(260)
    resetar_guinada()
    giroPID(12, 1.5, 0.002, 1)
    drive_base.straight(450)
    giroPID(30, 1.5, 0.002, 1)
    drive_base.straight(240)

    drive_base.straight(-200)


#=======================EXECUÃ‡ÃƒO PRINCIPAL==========================#
if __name__ == "__main__":

    states = [
        {"name": "Start 1 - Compartilhada", "action": lambda: start1()},
        {"name": "Start 2 - Tridente", "action": lambda: start2()},
        {"name": "Start 3 - Areia", "action": lambda: start3()},
        {"name": "Start 4 - 3 Artefatos", "action": lambda: start4()},
        {"name": "Start 5 - Balde/Telhado", "action": lambda: start5()},
        {"name": "Start 6 - Pedras", "action": lambda: start6()},
        {"name": "Start 7 - Indiana Jones/silo", "action": lambda: start7()},
        {"name": "Start 8 - Artefatos", "action": lambda: start8()},
        {"name": "Start 9 - Artefatos repetido", "action": lambda: start8()},   
    ]

    sm = StateMachine(states)
    sm.show_state()

    while True:
        if Button.RIGHT in hub.buttons.pressed():   # botÃ£o direito
            sm.next_state()
            wait(200)
        elif Button.LEFT in hub.buttons.pressed():  # botÃ£o esquerdo
            sm.prev_state()
            wait(200)
        elif Button.CENTER in hub.buttons.pressed():  # botÃ£o do meio
            sm.run_state()
            wait(200)
        elif Button.CENTER in hub.buttons.pressed() and Button.BLUETOOTH in hub.buttons.pressed():
            print("Encerrando...")
            break
