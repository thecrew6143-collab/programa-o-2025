from pybricks.pupdevices import Motor
from pybricks.parameters import Port, Direction, Button, Stop
from pybricks.robotics import DriveBase
from pybricks.hubs import PrimeHub
from pybricks.tools import wait


#=======================CONFIGURAÃ‡Ã•ES INICIAIS==========================#
hub = PrimeHub()

'''
print(hub.system.info()["name"])
# ðŸ”Ž Checagem de seguranÃ§a: sÃ³ roda se for o HUB certo
if hub.system.info()["name"] != "V8 HUB":
    print("Hub Errado")
    while True:               # trava execuÃ§Ã£o
        raise SystemExit  # encerra o programa
'''

hub.system.set_stop_button((Button.BLUETOOTH))

left_motor = Motor(Port.B, Direction.COUNTERCLOCKWISE)
right_motor = Motor(Port.F)
motor_direito = Motor(Port.A, Direction.COUNTERCLOCKWISE)
motor_esquerdo = Motor(Port.E)

dois_motores = DriveBase(motor_direito, motor_esquerdo, wheel_diameter=56, axle_track=112)
# Initialize the drive base
drive_base = DriveBase(left_motor, right_motor, wheel_diameter=56, axle_track=112)
drive_base.use_gyro(True)


#=======================FUNÃ‡Ã•ES DE MOVIMENTO==========================#
def giroPID(angulo, kp, ki, kd):
    integral = 0
    ultimo_erro = 0
    while abs(hub.imu.heading()) < abs(angulo):
        erro = angulo - hub.imu.heading()
        integral = integral + erro
        derivativa = erro - ultimo_erro
        movimento = (erro * kp) + (integral * ki) + (derivativa * kd)
        left_motor.run(movimento)
        right_motor.run(-movimento)
        ultimo_erro = erro
    left_motor.stop()
    right_motor.stop()


def config(velocidade, aceleracao):
    drive_base.settings(velocidade, aceleracao)


def resetar_guinada():
    drive_base.use_gyro(False)
    hub.imu.reset_heading(0)
    drive_base.use_gyro(True)


#=======================MÃQUINA DE ESTADO==========================#
class StateMachine:
    def __init__(self, states):
        self.states = states
        self.index = 0

    def next_state(self):
        self.index = (self.index + 1) % len(self.states)
        self.show_state()
    def prev_state(self):
        self.index = (self.index - 1) % len(self.states)
        self.show_state()

    def run_state(self):
        state = self.states[self.index]
        print(f"Executando aÃ§Ã£o do estado: {state['name']}")
        state["action"]()

    def show_state(self):
        print(f"Estado atual: {self.states[self.index]['name']}")
        hub.display.number(self.index + 1)


#=======================FUNÃ‡Ã•ES DE STARTS==========================#
def start1():  #START DO BARCO 
    drive_base.use_gyro(True)
    drive_base.settings(800,800)
    drive_base.straight(640)
    motor_direito.run_time(1000,1400)
    drive_base.settings(800,800)
    drive_base.straight(-40)
    drive_base.straight(80)
    motor_esquerdo.run_time(600,4000)
    drive_base.straight(-20)
    motor_direito.run_angle(900, -800, Stop.BRAKE, True)
    drive_base.settings(900,9000)
    drive_base.straight(-460)

    sm.next_state()
    drive_base.use_gyro(False)


def start2():  # START DA COMPARTRILHADA 
    drive_base.use_gyro(True)

    drive_base.settings(500, 800)
    drive_base.straight(600)
    resetar_guinada()
    giroPID(-86, 2, 0.0005, 1)
    drive_base.straight(-320)
    x = hub.imu.heading()
    resetar_guinada()
    giroPID(x*-1, 2, 0.0005, 1)
    drive_base.settings(300, 300)
    drive_base.straight(20)
    drive_base.straight(-25)
    motor_direito.run_angle(300, -290, Stop.BRAKE, True)
    motor_esquerdo.run_angle(-1000, 90, Stop.BRAKE, True)

    drive_base.settings(200, 200)
    drive_base.straight(180)
    motor_esquerdo.run_time(-1000, 1500, Stop.BRAKE, True)
    motor_esquerdo.run_time(-1000, 1000, Stop.BRAKE, True)
    '''drive_base.straight(40)
    motor_esquerdo.run_time(-1000, 700, Stop.BRAKE, True)'''
    drive_base.straight(-20)
    #motor_esquerdo.run_angle(1000, 150, Stop.BRAKE, True)

    motor_esquerdo.run_time(1000, 1200, Stop.BRAKE, True)
    resetar_guinada()
    drive_base.settings(900, 9000)
    drive_base.straight(-90)
    resetar_guinada()
    giroPID(82, 2, 0.0005, 1)
    drive_base.settings(900, 9000)
    drive_base.straight(-250)
    resetar_guinada()
    giroPID(-55, 3, 0.0005, 1)
    drive_base.settings(900, 9000)
    drive_base.straight(-650)

    sm.next_state()
    drive_base.use_gyro(False)

def start3():  # START DO TRIDENTE

    drive_base.use_gyro(True)
    motor_direito.run_angle(700, 450, Stop.BRAKE, wait=False)
    drive_base.settings(400, 400)
    drive_base.straight(700)
    
    #drive_base.settings(600, 6000)
    drive_base.straight(-150)
    drive_base.straight(80)
    wait(300)
    motor_esquerdo.run_angle(9000, 1000, Stop.BRAKE, wait=False)
    motor_direito.run_angle(-700,450, Stop.BRAKE, wait=True) 

    drive_base.settings(300, 200)
    resetar_guinada()
    giroPID(-42, 0.5, 0.001, 1)
    motor_direito.run_angle(700,500, Stop.BRAKE, True) 
    drive_base.straight(25)
    drive_base.settings(400, 400)
    drive_base.straight(130)
    motor_direito.run_time(-700,700, Stop.BRAKE, True)
    drive_base.straight(-130)
    resetar_guinada()
    giroPID(60, 0.5, 0.001, 1)
    drive_base.straight(-15)
    motor_direito.run_time(-700,760, Stop.BRAKE, True)
    drive_base.settings(900, 9000)

    drive_base.straight(-560)
    sm.next_state()
    drive_base.use_gyro(False)



def start4():  # START DO DINOSSAURO/3 ARTEFATOS/TRAVESSIA
    resetar_guinada()
    drive_base.settings(300,300)
    drive_base.straight(80)
    giroPID(43,0.7,0.001,1)
    dois_motores.settings(900,900)
    dois_motores.straight(-160)
    drive_base.straight(420)
    drive_base.straight(-125)
    resetar_guinada()
    giroPID(46,1.5,0.001,1)
    drive_base.straight(390)
    dois_motores.straight(180)
    resetar_guinada()
    giroPID(-62,1.5,0.001,1)
    #dois_motores.straight(-170)
    drive_base.straight(20)
    motor_direito.run_time(-600,700, wait=False)

    motor_esquerdo.run_time(-600,700, wait=True)

    drive_base.straight(-30)
    resetar_guinada()
    giroPID(60,1.5,0.001,1)
    drive_base.settings(900,9000)
    drive_base.straight(1100)
    sm.next_state()
    drive_base.use_gyro(False)

def start5():  # START DO TELHADO
    drive_base.use_gyro(True)
    hub.imu.reset_heading(0)
    drive_base.settings(550,600)
    drive_base.straight(40)
    giroPID(-41, 1.2, 0.0004, 1)
    motor_esquerdo.run_time(1000, 600, Stop.BRAKE, False)
    #drive_base.straight(300)
    drive_base.settings(550,1000)

    drive_base.straight(445)
    motor_esquerdo.run_time(-900, 1400, Stop.BRAKE, True)
    motor_esquerdo.run_time(800, 900, Stop.BRAKE, True)

    motor_direito.run_time(-1000, 1100, Stop.BRAKE, True)
    
    motor_esquerdo.run_time(800, 1000, Stop.BRAKE, True)
    
    drive_base.settings(500,500)
    drive_base.straight(-110)
    motor_direito.run_time(1000, 800, Stop.BRAKE, True)
    resetar_guinada()
    giroPID(-31, 0.7, 0.001, 1)

    drive_base.settings(900, 9000)
    motor_direito.run_time(1000, 1200, Stop.BRAKE, wait=False)


    drive_base.straight(-390)
    

    sm.next_state()
    drive_base.use_gyro(False) 

def start6():  # START DAS PEDRAS
    drive_base.use_gyro(True)
    drive_base.settings(400, 300)
    drive_base.straight(620)
    motor_direito.run_time(-800, 1000, Stop.BRAKE, True)
    drive_base.settings(600, 1000)
    drive_base.straight(110)
    motor_direito.run_time(100, 3100, Stop.BRAKE, True)
    drive_base.straight(-55)  
    resetar_guinada()
    giroPID(-20, 1.2, 0.0004, 1)
    drive_base.straight(-35)
    x=hub.imu.heading()
    resetar_guinada()
    giroPID(-90-x, 1.2, 0.0004, 1)
    drive_base.settings(500, 800)
    drive_base.straight(-200)
    motor_esquerdo.run_time(800, 500, Stop.BRAKE, False)
    drive_base.straight(220)
    resetar_guinada()
    giroPID(-122, 0.9, 0.0004, 1)
    drive_base.straight(50)    
    motor_esquerdo.run_time(-800, 1000, Stop.BRAKE, True)
    motor_esquerdo.run_time(800, 1000, Stop.BRAKE, True)
    motor_esquerdo.run_time(-800, 1000, Stop.BRAKE, True)
    motor_esquerdo.run_time(800, 1000, Stop.BRAKE, True)

    resetar_guinada()
    giroPID(20, 1.2, 0.001, 1)
    drive_base.settings(900, 9000)
    drive_base.straight(530)
    sm.next_state()
    drive_base.use_gyro(False)

def start7():  # START DO INDIANA JONES
    drive_base.use_gyro(True)
    hub.imu.reset_heading(0)
    drive_base.settings(500,600)
    drive_base.straight(230)
    resetar_guinada()
    giroPID(-20, 1.2, 0.001, 1)
    drive_base.straight(310)
    resetar_guinada()
    giroPID(-29, 1.2, 0.0004, 1)
    drive_base.straight(260)
    drive_base.settings(500,500)
    drive_base.straight(-40)
    dois_motores.straight(-80)
    drive_base.settings(900,9000)
    drive_base.straight(-200)
    resetar_guinada()
    giroPID(25, 1.2, 0.0004, 1)

    motor_direito.run_time(900,1200, wait=False)

    motor_esquerdo.run_time(900,1200, wait=False)

    drive_base.straight(-550)
    


    #dois_motores.straight(80)
    
    sm.next_state()
    drive_base.use_gyro(False)
   

def start8():  # START DOS ARTEFATOS
    drive_base.use_gyro(True)
    hub.imu.reset_heading(0)
    drive_base.settings(500, 700)
    drive_base.straight(260)
    resetar_guinada()
    giroPID(21, 1.5, 0.002, 1)
    drive_base.straight(450)
    resetar_guinada()
    giroPID(6, 1.5, 0.002, 1)    
    drive_base.straight(250)
    giroPID(17, 1.5, 0.2, 1)
    dois_motores.settings(100,100)
    dois_motores.straight(-170)
    drive_base.settings(400,400)
    drive_base.straight(130)
    drive_base.straight(-200)


#=======================EXECUÃ‡ÃƒO PRINCIPAL==========================#
if __name__ == "__main__":

    states = [
        {"name": "Start 1 - BARCO", "action": lambda: start1()},
        {"name": "Start 2 - TRIDENTE", "action": lambda: start2()},
        {"name": "Start 3 - COMPARTILHADA", "action": lambda: start3()},
        {"name": "Start 4 - 3 ARTEFATOS/ DINOSSAURO", "action": lambda: start4()},
        {"name": "Start 5 - PEDRAS/ SILO", "action": lambda: start5()},
        {"name": "Start 6 - TELHADO ", "action": lambda: start6()},
        {"name": "Start 7 - INDIANA JONES ", "action": lambda: start7()},
        {"name": "Start 8 - ARTEFATOS", "action": lambda: start8()},
        {"name": "Start 9 - ARTEFATOS REPETIDO ", "action": lambda: start8()},   
    ]

    sm = StateMachine(states)
    sm.show_state()

    while True:
        if Button.RIGHT in hub.buttons.pressed():   # botÃ£o direito
            sm.next_state()
            wait(200)
        elif Button.LEFT in hub.buttons.pressed():  # botÃ£o esquerdo
            sm.prev_state()
            wait(200)
        elif Button.CENTER in hub.buttons.pressed():  # botÃ£o do meio
            sm.run_state()
            wait(200)
        elif Button.CENTER in hub.buttons.pressed() and Button.BLUETOOTH in hub.buttons.pressed():
            print("Encerrando...")
            break
